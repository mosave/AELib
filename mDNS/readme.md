# AE' ESP8266 IoT Framework

## Настройка mDNS анонсирования MQTT брокера 

Обеспечить резервирование WiFi роутера достаточно просто. В конце концов, при его выходе из строя или апгрейде достаточно 
просто настроить тот же самый SSID и пароль - и IoT устройства сами подключатся к новому роутеру.

Несколько сложнее обстоит дело с MQTT брокером, который так же необходим для нормального функционирования устройств.
Да, MQTT брокер можно иногда установить на самом роутере (например, на роутеры с прошивкой OpenWRT или некоторые устройсва Keenetic)
И даже прописать в файле config.h не IP адрес брокера а его dns имя и искать брокер по нему.

Однако более интересный вариант - анонсирование MQTT брокера в локальной сети с помощью сервиса mDNS (он же Bonjur, 
он же ZeroConf, он же RendezVous, он же Жора, он же Гога...). Для этого на любом из локальных серверов 
(проще всего на том же роутере или сервере на котором установлен сам MQTT брокер) нужно установить и настроить mDNS сервис.

Инструкций по установке avahi, mDNSResponder, Bonjur, ZeroConf в интернете достаточно. 
Тем не менее я продублирую здесь описание процедуры настройки avahi, самого популярного mDNS сервиса.

Установить сервис на OperWRT роутер можно через web-интерфейс роутера:

'''System => Software => Update Lists => Available => установить пакет avahi-dbus-daemon'''

Установить сервис на unix системе с системой управления пакетов apt (debian, ubuntu...)

'''sudo apt install avahi-daemon'''

После в каталоге /etc/avahi/services необходимо создать описание сервиса анонсирования mqtt.
Для этого в каталоге нужно создать файл 
[mqtt.service](https://github.com/mosave/AELib/blob/main/mDNS/mqtt.service)
 со следующим содержанием:


'''
<?xml version="1.0"?>
<service-group>
    <name>MQTT Broker on House</name>
    <service>
        <type>_mqtt._tcp</type>
        <port>1883</port>
        <!--host-name>mosquitto</host-name-->
    </service>
</service-group>
'''

Если сервис должен анонсировать MQTT брокер, установленный на другом сервере, то в приведенном выше коде необходимо
убрать комментарии с параметра "host-name" а в файле 

[/etc/avahi/hosts](https://github.com/mosave/AELib/blob/main/mDNS/hosts)

определить имя хоста **mosquitto**.



В этом каталоге вы найдете примеры этих файлов конфигурации.


